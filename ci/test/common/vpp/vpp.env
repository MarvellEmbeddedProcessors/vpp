#!/bin/bash
# SPDX-License-Identifier: Apache-2.0
# Copyright(C) 2025 Marvell.

VPP_SCRIPT_PATH=$(dirname $(readlink -f "${BASH_SOURCE[0]}"))
source $VPP_SCRIPT_PATH/../testpmd/common.env

if [[ -f $VPP_SCRIPT_PATH/../../../../build-root/install-cnxk-aarch64/vpp/bin/vpp ]]; then
	# This is running from build directory
	VPP=$VPP_SCRIPT_PATH/../../../../build-root/install-cnxk-aarch64/vpp/bin/vpp
	export LD_LIBRARY_PATH=$VPP_SCRIPT_PATH/../../../../build-root/install-cnxk-aarch64/vpp/lib
elif [[ -f $VPP_SCRIPT_PATH/../../../../build-root/install-cnxk_debug-aarch64/vpp/bin/vpp ]]; then
	VPP=$VPP_SCRIPT_PATH/../../../../build-root/install-cnxk_debug-aarch64/vpp/bin/vpp
	export LD_LIBRARY_PATH=$VPP_SCRIPT_PATH/../../../../build-root/install-cnxk_debug-aarch64/vpp/lib
elif [[ -f $VPP_SCRIPT_PATH/../../../../build-root/install-vpp-native/vpp/bin/vpp ]]; then
	VPP=$VPP_SCRIPT_PATH/../../../../build-root/install-vpp-native/vpp/bin/vpp
	export LD_LIBRARY_PATH=$VPP_SCRIPT_PATH/../../../../build-root/install-vpp-native/vpp/lib
elif [[ -f $VPP_SCRIPT_PATH/../../../../build-root/install-vpp_debug-native/vpp/bin/vpp ]]; then
	VPP=$VPP_SCRIPT_PATH/../../../../build-root/install-vpp_debug-native/vpp/bin/vpp
	export LD_LIBRARY_PATH=$VPP_SCRIPT_PATH/../../../../build-root/install-vpp_debug-native/vpp/lib
else
	VPP=$(which vpp)
fi

if [[ -z $VPP ]]; then
	echo "vpp not found !!"
	exit 1
fi

if [[ -f $VPP_SCRIPT_PATH/../../../../build-root/install-cnxk-aarch64/vpp/bin/vppctl ]]; then
	# This is running from build directory
	VPPCTL=$VPP_SCRIPT_PATH/../../../../build-root/install-cnxk-aarch64/vpp/bin/vppctl
elif [[ -f $VPP_SCRIPT_PATH/../../../../build-root/install-cnxk_debug-aarch64/vpp/bin/vppctl ]]; then
	VPPCTL=$VPP_SCRIPT_PATH/../../../../build-root/install-cnxk_debug-aarch64/vpp/bin/vppctl
elif [[ -f $VPP_SCRIPT_PATH/../../../../build-root/install-vpp-native/vpp/bin/vppctl ]]; then
	VPPCTL=$VPP_SCRIPT_PATH/../../../../build-root/install-vpp-native/vpp/bin/vppctl
elif [[ -f $VPP_SCRIPT_PATH/../../../../build-root/install-vpp_debug-native/vpp/bin/vppctl ]]; then
	VPPCTL=$VPP_SCRIPT_PATH/../../../../build-root/install-vpp_debug-native/vpp/bin/vppctl
else
	VPPCTL=$(which vppctl)
fi

if [[ -z $VPPCTL ]]; then
	echo "vppctl not found !!"
	exit 1
fi

function vpp_cleanup()
{
	local startup_conf=$1

	# Issue kill
	ps -eo "pid,args" | grep "vpp \-c" | grep $startup_conf | \
		awk '{print $1}' | xargs -I[] -n1 kill -9 [] 2>/dev/null || true

	# Wait until the process is killed
	while (ps -ef | grep "vpp \-c" | grep -q $startup_conf); do
		continue
	done
}

function vpp_launch()
{
	local startup_conf=$1

	vpp_cleanup $1
	$VPP -c $startup_conf.conf & >1.log
	sleep 2
}

function vpp_exec_cmd()
{
	local startup_conf=$1
	local cmd=$2
	set +e
	$VPPCTL -s /tmp/$startup_conf/cli.sock $cmd
	set -e
}

function vpp_start()
{
	local startup_conf=$1
        set +e
	$VPPCTL -s /tmp/$startup_conf/cli.sock exec /tmp/$startup_conf/$startup_conf.exec
	sleep 2
	$VPPCTL -s /tmp/$startup_conf/cli.sock clear interfaces
	sleep 2
        set -e
}

function vpp_add_trace()
{
        set +e
	local startup_conf=$1
	local port=$2

	$VPPCTL -s /tmp/$startup_conf/cli.sock trace add $2-rx 100
        set -e
}

function vpp_show_trace()
{
        set +e
	local startup_conf=$1

	$VPPCTL -s /tmp/$startup_conf/cli.sock show trace > /tmp/$startup_conf/trace.log
	cat /tmp/$startup_conf/trace.log
        set -e
}

function vpp_port_down()
{
	local startup_conf=$1
	local port=$2

	set +e
	$VPPCTL -s /tmp/$startup_conf/cli.sock set int state $2 down
	set -e
}

function vpp_stats_all()
{
	set +e
	local test=$1
	echo $VPPCTL -s /tmp/$test/cli.sock show interface > /tmp/$test/stats_all.log
	$VPPCTL -s /tmp/$test/cli.sock show interface > /tmp/$test/stats_all.log
	cat /tmp/$test/stats_all.log
        set -e
}

function vpp_stats()
{
	set +e
	local test=$1
	local port=$2
	echo $VPPCTL -s /tmp/$test/cli.sock show interface $port> /tmp/$test/stats.log
	$VPPCTL -s /tmp/$test/cli.sock show interface $port> /tmp/$test/stats.log
	cat /tmp/$test/stats.log
	set -e
}

function vpp_rx_count()
{
	set +e
	$VPPCTL -s /tmp/$1/cli.sock show interface | grep "rx packets" | awk '{print $7}' | tr -d '\r'
	set -e
}

function vpp_rx_bytes()
{
	set +e
	$VPPCTL -s /tmp/$1/cli.sock show interface | grep "rx bytes" | awk '{print $3}' | tr -d '\r'
	set -e
}
function vpp_tx_count()
{
	set +e
	$VPPCTL -s /tmp/$1/cli.sock show interface | grep "tx packets" | awk '{print $3}' | tr -d '\r'
	set -e
}

function vpp_tx_bytes()
{
	set +e
	$VPPCTL -s /tmp/$1/cli.sock show interface | grep "tx bytes" | awk '{print $3}' | tr -d '\r'
	set -e
}

function vpp_log()
{
	set +e
	local test=$1
	$VPPCTL -s /tmp/$test/cli.sock show log > /tmp/$test/vpp.log
	$VPPCTL -s /tmp/$test/cli.sock show hardware-interfaces >> /tmp/$test/vpp.log
	$VPPCTL -s /tmp/$test/cli.sock show device counters >> /tmp/$test/vpp.log
	$VPPCTL -s /tmp/$test/cli.sock show run >> /tmp/$test/vpp.log
	$VPPCTL -s /tmp/$test/cli.sock show error >> /tmp/$test/vpp.log
	$VPPCTL -s /tmp/$test/cli.sock show int >> /tmp/$test/vpp.log
	cat /tmp/$test/vpp.log
        set -e
}
